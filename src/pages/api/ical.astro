---
import { getNamesByDate, getDatesByName } from '../../lib/meniny';
import { generateICS, generateICSForDate, getICSFilename } from '../../lib/ics';

const { searchParams } = Astro.url;
const date = searchParams.get('date');
const name = searchParams.get('name');

let icsContent = '';
let filename = 'meniny.ics';

if (date) {
  // Generate ICS for a specific date
  const names = await getNamesByDate(date);
  icsContent = generateICSForDate(date, names);
  filename = `meniny-${date}.ics`;
} else if (name) {
  // Generate ICS for a specific name
  const dates = await getDatesByName(name);
  icsContent = generateICS(name, dates);
  filename = getICSFilename(name);
} else {
  // Return error
  return new Response('Missing date or name parameter', { status: 400 });
}

return new Response(icsContent, {
  status: 200,
  headers: {
    'Content-Type': 'text/calendar; charset=utf-8',
    'Content-Disposition': `attachment; filename="${filename}"`,
    'Cache-Control': 'public, max-age=3600'
  }
});
---
