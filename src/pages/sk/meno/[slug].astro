---
export const prerender = false; // Server-render on demand to reduce build size

import Layout from '../../../layouts/Layout.astro';
import { getDatesByName, getAllNames, getNextOccurrence, getPrevOccurrence } from '../../../lib/meniny';
import { toSlug, fromSlug } from '../../../lib/slug';
import { formatDateSlovak } from '../../../lib/date';
import NameOrigin from '../../../components/NameOrigin.astro';
import SimilarNames from '../../../components/SimilarNames.astro';
import InternationalVariants from '../../../components/InternationalVariants.astro';
import CalendarReminderModal from '../../../components/CalendarReminderModal.astro';

export async function getStaticPaths() {
  // Get all names and generate paths
  const allNames = await getAllNames();
  
  return allNames.map(name => ({
    params: {
      slug: toSlug(name)
    }
  }));
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/sk');
}

// Find the actual name from the slug
const allNames = await getAllNames();
const actualName = allNames.find(name => toSlug(name) === slug);

if (!actualName) {
  return Astro.redirect('/sk');
}

const dates = await getDatesByName(actualName);
const nextOccurrence = await getNextOccurrence(actualName, new Date());
const prevOccurrence = await getPrevOccurrence(actualName, new Date());

// Generate structured data
const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": `${actualName} - meniny, pÃ´vod, darÄeky`,
  "description": `Meno ${actualName} mÃ¡ meniny ${dates.length} krÃ¡t do roka. Zistite kedy, nÃ¡jdite darÄekovÃ© nÃ¡pady a viac informÃ¡ciÃ­.`,
  "url": `https://meniny365.sk/sk/meno/${slug}`,
  "mainEntity": {
    "@type": "Person",
    "name": actualName,
    "description": `Meno ${actualName} mÃ¡ meniny ${dates.length} krÃ¡t do roka`,
    "birthDate": dates[0] || null
  }
};
---

<Layout 
  title={`${actualName} - meniny, pÃ´vod, darÄeky | meniny365`}
  description={`Meno ${actualName} mÃ¡ meniny ${dates.length} krÃ¡t do roka. Zistite kedy, nÃ¡jdite darÄekovÃ© nÃ¡pady a viac informÃ¡ciÃ­ o pÃ´vode mena.`}
  canonical={`https://meniny365.sk/sk/meno/${slug}`}
  structuredData={structuredData}
>
  <div class="container py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm text-[var(--muted)]">
        <li><a href="/sk" class="hover:text-[var(--brand)] transition-colors">Dnes</a></li>
        <li>/</li>
        <li class="text-[var(--text)]">{actualName}</li>
      </ol>
    </nav>

    <!-- Name Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-[var(--text)] mb-4">
        {actualName}
      </h1>
      
      <div class="flex justify-center items-center space-x-4 mb-8">
        <span class="px-4 py-2 bg-[var(--brand)]/20 text-[var(--brand)] rounded-full text-sm font-medium">
          Meniny
        </span>
        <span class="px-4 py-2 bg-[var(--accent)]/20 text-[var(--accent)] rounded-full text-sm font-medium">
          {dates.length} krÃ¡t do roka
        </span>
      </div>
      
      <div class="card p-6 max-w-2xl mx-auto">
        <button 
          id="addToCalendar"
          class="btn btn-primary text-lg px-6 py-3 w-full"
        >
          ğŸ“… PridaÅ¥ do kalendÃ¡ra
        </button>
      </div>
    </div>

    <!-- DÃ¡tumy menÃ­n -->
    <div class="card p-8 mb-12">
      <h2 class="text-2xl font-semibold text-[var(--text)] mb-6">DÃ¡tumy menÃ­n</h2>
      
      {dates.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {dates.map(dateStr => {
            const date = new Date(dateStr);
            const isUpcoming = date >= new Date();
            
            return (
              <a
                href={`/sk/den/${dateStr.split('-')[0]}/${dateStr.split('-')[1]}/${dateStr.split('-')[2]}`}
                data-date={dateStr}
                class={`
                  p-4 rounded-lg border transition-all
                  ${isUpcoming 
                    ? 'bg-[var(--brand)]/10 border-[var(--brand)] hover:bg-[var(--brand)]/20' 
                    : 'bg-[var(--card)] border-[var(--border)] hover:bg-[var(--hover)]'
                  }
                `}
              >
                <div class="text-lg font-semibold text-[var(--text)]">
                  {formatDateSlovak(date)}
                </div>
                {isUpcoming && (
                  <div class="text-sm text-[var(--brand)] mt-1">
                    NajbliÅ¾Å¡Ã­ termÃ­n
                  </div>
                )}
              </a>
            );
          })}
        </div>
      ) : (
        <p class="text-[var(--muted)]">Å½iadne dÃ¡tumy menÃ­n nie sÃº dostupnÃ©.</p>
      )}
    </div>

    <!-- Insight Blocks -->
    <div class="space-y-8 mb-12">
      <NameOrigin name={actualName} />
      <SimilarNames name={actualName} />
      <InternationalVariants name={actualName} />
    </div>

    <!-- DarÄekovÃ© nÃ¡pady -->
    <div class="card p-8 mb-12">
      <h2 class="text-2xl font-semibold text-[var(--text)] mb-6">DarÄekovÃ© nÃ¡pady pre {actualName}</h2>
      
      <div class="text-center mb-6">
        <a 
          href="/sk/darceky" 
          class="inline-flex items-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 transform hover:scale-105"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          GenerovaÅ¥ darÄekovÃ© nÃ¡pady
        </a>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="p-4 border border-[var(--border)] rounded-lg">
          <h3 class="font-semibold text-[var(--text)] mb-2">TradiÄnÃ© darÄeky</h3>
          <ul class="text-sm text-[var(--muted)] space-y-1">
            <li>â€¢ Kvetiny</li>
            <li>â€¢ ÄŒokolÃ¡da</li>
            <li>â€¢ Kniha</li>
            <li>â€¢ ParfÃ©m</li>
          </ul>
        </div>
        
        <div class="p-4 border border-[var(--border)] rounded-lg">
          <h3 class="font-semibold text-[var(--text)] mb-2">ModernÃ© darÄeky</h3>
          <ul class="text-sm text-[var(--muted)] space-y-1">
            <li>â€¢ Gadgety</li>
            <li>â€¢ SkÃºsenosti</li>
            <li>â€¢ DigitÃ¡lne darÄeky</li>
            <li>â€¢ PersonalizovanÃ© predmety</li>
          </ul>
        </div>
        
        <div class="p-4 border border-[var(--border)] rounded-lg">
          <h3 class="font-semibold text-[var(--text)] mb-2">PodÄ¾a rozpoÄtu</h3>
          <ul class="text-sm text-[var(--muted)] space-y-1">
            <li>â€¢ Do 20â‚¬ - malÃ© darÄeky</li>
            <li>â€¢ 20-50â‚¬ - strednÃ© darÄeky</li>
            <li>â€¢ 50-100â‚¬ - drahÅ¡ie darÄeky</li>
            <li>â€¢ 100â‚¬+ - luxusnÃ© darÄeky</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- SÃºvisiace ÄlÃ¡nky -->
    <div class="card p-8 mb-12">
      <h2 class="text-2xl font-semibold text-[var(--text)] mb-6">SÃºvisiace ÄlÃ¡nky</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <a href="/sk/blog/meniny-na-slovensku" class="p-4 border border-[var(--border)] rounded-lg hover:bg-[var(--hover)] transition-colors">
          <h3 class="font-semibold text-[var(--text)] mb-2">Meniny na Slovensku: tradÃ­cie a zvyky</h3>
          <p class="text-sm text-[var(--muted)]">Zistite viac o tradÃ­ciÃ¡ch a zvykoch spojenÃ½ch s meninami na Slovensku.</p>
        </a>
        
        <a href="/sk/blog/darceky-na-meniny" class="p-4 border border-[var(--border)] rounded-lg hover:bg-[var(--hover)] transition-colors">
          <h3 class="font-semibold text-[var(--text)] mb-2">20 tipov na darÄeky na meniny</h3>
          <p class="text-sm text-[var(--muted)]">NÃ¡jdite perfektnÃ½ darÄek pre kaÅ¾dÃ½ rozpoÄet a prÃ­leÅ¾itosÅ¥.</p>
        </a>
      </div>
    </div>

    <!-- Related Links -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <a href="/sk" class="card p-6 hover:scale-105 transition-transform">
        <h3 class="text-xl font-semibold text-[var(--text)] mb-2">ğŸ“… Dnes mÃ¡ meniny</h3>
        <p class="text-[var(--muted)]">Zistite kto mÃ¡ dnes meniny</p>
      </a>
      
      <a href="/sk/populÃ¡rne-menÃ¡" class="card p-6 hover:scale-105 transition-transform">
        <h3 class="text-xl font-semibold text-[var(--text)] mb-2">ğŸ”¥ PopulÃ¡rne menÃ¡</h3>
        <p class="text-[var(--muted)]">Zistite ktorÃ© menÃ¡ sÃº najpopulÃ¡rnejÅ¡ie</p>
      </a>
      
      <a href="/sk/nÃ¡vrhy-mena" class="card p-6 hover:scale-105 transition-transform">
        <h3 class="text-xl font-semibold text-[var(--text)] mb-2">ğŸ’¡ NÃ¡vrhy mien</h3>
        <p class="text-[var(--muted)]">NÃ¡jdite perfektnÃ© meno pre vaÅ¡e dieÅ¥a</p>
      </a>
    </div>

    <!-- Calendar Reminder Modal -->
    <CalendarReminderModal />
  </div>
</Layout>

<script>
  // Handle "PridaÅ¥ do kalendÃ¡ra" button
  document.addEventListener('DOMContentLoaded', () => {
    const addToCalendarBtn = document.getElementById('addToCalendar');
    
    if (addToCalendarBtn) {
      addToCalendarBtn.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Get name and dates from the page
        const name = document.querySelector('h1')?.textContent?.trim() || '';
        const dates = Array.from(document.querySelectorAll('[data-date]')).map(el => 
          el.getAttribute('data-date')
        ).filter(Boolean);
        
        if (dates.length > 0) {
          // Dispatch event to open calendar modal
          const event = new CustomEvent('openCalendarModal', {
            detail: { name, dates }
          });
          document.dispatchEvent(event);
        } else {
          alert('Å½iadne dÃ¡tumy menÃ­n nie sÃº dostupnÃ©.');
        }
      });
    }
  });
</script>
